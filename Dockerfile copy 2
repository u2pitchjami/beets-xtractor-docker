# Base image
FROM debian:bullseye-slim AS buildbase
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip python3-gi \
    && rm -rf /var/lib/apt/lists/*

# install gaia
FROM buildbase AS gaia
# Install SWIG
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip python3-gi python3-dev \
    libpcre3-dev cmake build-essential \
    wget git pkg-config
COPY assets/swig-3.0.12.tar.gz /app/
RUN ln -s /usr/bin/python3 /usr/bin/python \
    && cd /app \
    && tar -xzf swig-3.0.12.tar.gz \
    && cd swig-3.0.12 \
    && ./configure \
    && make \
    && make install
   # Install Gaia from GitHub
RUN git clone https://github.com/MTG/gaia.git /app/gaia-src \
    && cd /app/gaia-src \
    && ./waf configure --with-python-bindings --with-asserts \
    && ./waf build \
    && ./waf install --destdir /app/gaia \
    && rm -rf /var/lib/apt/lists/*

# Extract and build Essentia + SVM models for Essentia
FROM buildbase AS essentia
COPY assets/essentia-2.1_beta5.tar.gz /app/
COPY assets/essentia-extractor-svm_models-v2.1_beta5.tar.gz /app/
RUN apt-get update && apt-get install -y --no-install-recommends \ 
    python3-pip python3-gi python3-dev libfftw3-dev libavcodec-dev libavformat-dev libavresample-dev libswresample-dev libavutil-dev libtag1-dev libchromaprint-dev libsamplerate0-dev libeigen3-dev \
    && pip3 install numpy==1.19.5
COPY --from=gaia /app/gaia /
# Install Eigen
COPY assets/eigen-3.4.0.tar.gz /app/
RUN cd /app \
&& tar -xzf eigen-3.4.0.tar.gz \
&& cd eigen-3.4.0 \
&& mkdir build \
&& cd build \
&& cmake .. \
&& make install
RUN cd /app \
    && tar -xzf essentia-2.1_beta5.tar.gz 
ENV CXXFLAGS="-I/usr/local/include/eigen3"
WORKDIR /app/essentia-2.1_beta5
RUN ln -s /usr/bin/python3 /usr/bin/python \
    && wget https://waf.io/waf-2.0.23 \
    && mv waf-2.0.23 waf \
    && chmod +x waf \
    && ./waf configure --build-static --with-python --with-examples --with-gaia \
    && ./waf build \
    && ./waf install --destdir /app/essentia \
    && ldconfig \
    && cd /app \
    && mkdir -p /app/default_config/svm_models \
    && tar -xzf essentia-extractor-svm_models-v2.1_beta5.tar.gz \
    && cp -r essentia-extractor-svm_models-v2.1_beta5/* /app/default_config/svm_models/ \
    && rm -rf /app/essentia-extractor-svm_models-v2.1_beta5 /app/essentia-extractor-svm_models-v2.1_beta5.tar.gz \
    && rm -rf /app/essentia-2.1_beta5 /app/essentia-2.1_beta5.tar.gz \
    && rm -rf /var/lib/apt/lists/*

#Imagick & Keyfinder
FROM buildbase AS beets_dep
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip python3-gi \
    cmake build-essential \
    wget git pkg-config libfftw3-dev \
    libavcodec-dev libavformat-dev libavresample-dev libswresample-dev libavutil-dev libtag1-dev libchromaprint-dev libsamplerate0-dev \
    libjpeg-dev libpng-dev libtiff-dev libwebp-dev libtool libxml2-dev libfontconfig-dev libfreetype6-dev liblcms2-dev libopenexr-dev libx11-dev libxext-dev libxt-dev \
    && wget https://download.imagemagick.org/ImageMagick/download/ImageMagick.tar.gz \
    && tar -xzf ImageMagick.tar.gz \
    && cd ImageMagick-* \
    && ./configure \
    && make \
    && make DESTDIR=/app/imagemagick install \
# Install libkeyfinder dependency
    && git clone https://github.com/mixxxdj/libkeyfinder.git /app/libkeyfinder-src \
    && cd /app/libkeyfinder-src \
    && cmake -DCMAKE_INSTALL_PREFIX=/usr/local -S . -B build \
    && cmake --build build --parallel $(nproc) \
    && cmake --install build \
    && ldconfig \
# Install Keyfinder from GitHub
    && git clone https://github.com/evanpurkhiser/keyfinder-cli.git /app/keyfinder-cli-src \
    && cd /app/keyfinder-cli-src \
    && git submodule update --init --recursive \
    && make \
    && make DESTDIR=/app/keyfinder-cli install \
    && ldconfig \
    && rm -rf /var/lib/apt/lists/*
    
# Beets
FROM buildbase AS beets
    RUN apt-get update && apt-get install -y --no-install-recommends \
    python3-pip python3-gi python3-dev ffmpeg git cargo cmake build-essential wget pkg-config libcairo2 libcairo2-dev \
    && pip3 install beets==2.1.0 \
    && pip3 install Flask requests-oauthlib numpy==1.19.5 pycairo \
    && pip3 install beets[fetchart,thumbnails,embedart,scrub,lyrics,autobpm,discog,replaygain,chroma,web] \
    && pip3 install discogs_client beets-beatport4 beets-xtractor beetcamp beets-yearfixer beets-describe beets-check \
    && python3 -m pip install beets-autogenre

COPY --from=essentia /app/essentia /
COPY --from=beets_dep /app/imagemagick /
COPY --from=beets_dep /app/keyfinder-cli /
# Copy default config
COPY config/config.yaml.example /app/default_config/config.yaml
COPY config/beatport_credentials.yaml.example /app/default_config/beatport_credentials.yaml

# Set entrypoint script
COPY scripts/entrypoint.sh /app/
RUN chmod +x /app/entrypoint.sh \
    && apt-get autoremove -y \
    && rm -rf /var/lib/apt/lists/*

ENTRYPOINT ["/app/entrypoint.sh"]